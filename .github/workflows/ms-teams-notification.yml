name: 1. Send MS Teams Notification ðŸ‘¥
on: 
  workflow_dispatch:
  push:
    branches:    
      - main

env:
  ARTIFACT_FILE: dummy.txt
  ARTIFACT_NAME: my-apk-build
  ARTIFACT_URL: www.msn.com

jobs:
  teams-notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Generate dummy artifact
      run: echo "Hello, World!" > ${{ env.ARTIFACT_FILE }}
      env:
        ARTIFACT_NAME: ${{ env.ARTIFACT_NAME }}


    - name: Upload Artifact
      id: upload-artifact
      uses: actions/upload-artifact@v3
      env:
        ARTIFACT_NAME: ${{ env.ARTIFACT_NAME }}      
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ${{ env.ARTIFACT_FILE }}
         
    
    # - name: Download Artifact
    #   id: download-artifact
    #   uses: actions/download-artifact@v3
    #   with:
    #     name: ${{ env.ARTIFACT_NAME }}

    - name: Set artifact URL
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'    
      run: echo "ARTIFACT_URL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/"
      #run: echo "ARTIFACT_URL=${{ steps.upload-artifact.outputs.url }" >> $GITHUB_ENV
      #run: echo "ARTIFACT_URL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/suites/0000/artifacts/1111" >> $GITHUB_ENV
      
    - name: Test artifact URL
      run: echo "The artifact URL is ${{ env.ARTIFACT_URL }}"

    - name: Temp test  URL
      run: |
        echo "artifact url ${{ steps.upload-artifact.outputs.ARTIFACT_NAME.url }}"
        echo "artifact url ${{ steps.upload-artifact.outputs.my-apk-build.url }}"

# ################# APP CENTER
#     - name: set up JDK 1.8
#       uses: actions/setup-java@v1
#       with:
#         java-version: 1.8
#     - name: build release 
#       run: ./gradlew assembleRelease
#     - name: App Center Distribute
#       uses: devussy/AppCenter-Distribute-Github-Action@master
#       with:
#         app: devussy/SampleApp
#         token: ${{secrets.APP_CENTER_TOKEN}}
#         group: TargetGroup
#         file: ${{ env.ARTIFACT_FILE }}
#         silent: false
# #################            

    - name: Notify MS Teams
      run: |
        curl -X POST -H "Content-Type: application/json" -d '{
          "@type": "MessageCard",
          "@context": "https://schema.org/extensions",
          "summary": "Build and Test complete",
          "themeColor": "0076D7",
          "title": "Build and Test complete",
          "text": "The build and test for the code has completed.
          The artifact can be found at ${{ env.ARTIFACT_URL }}",
          "potentialAction": [
            {
              "@type": "OpenUri",
              "name": "View artifact",
              "targets": [
                { "os": "default", "uri": "${{ env.ARTIFACT_URL }}" }
              ]
            }
          ]
        }' ${{ secrets.MS_TEAMS_WEBHOOK_URL }}                


